# GitHub Actions CI/CD Pipeline for ML
# Triggers on: push to main, pull requests
# Does: Data validation â†’ Model training â†’ Artifact push to registry

name: ML Pipeline CI/CD

on:
  # Trigger on push to main branch
  push:
    branches:
      - main
    # Removed paths filter - run on any push to main

  # Trigger on pull requests to main
  pull_request:
    branches:
      - main
    # Removed paths filter - validate all PRs

  # Allow manual trigger
  workflow_dispatch:

# Environment variables (shared across all jobs)
env:
  PYTHON_VERSION: '3.12'
  MLFLOW_TRACKING_URI: 'file:./logs/mlruns'

jobs:
  # ============================================================================
  # JOB 1: Data Validation
  # ============================================================================
  data-validation:
    name: ğŸ” Data Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Run data validation
        run: |
          echo "Running data quality checks..."
          python pipeline/stage_01_ingest_data.py

          # Check if data quality report exists
          if [ ! -f "logs/data_quality_report.json" ]; then
            echo "âŒ Data quality report not generated!"
            exit 1
          fi

          echo "âœ… Data validation passed!"

      - name: ğŸ“Š Upload data quality report
        uses: actions/upload-artifact@v4
        with:
          name: data-quality-report
          path: logs/data_quality_report.json
          retention-days: 30

      - name: ğŸ’¬ Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('logs/data_quality_report.json', 'utf8'));

            const comment = `## ğŸ” Data Validation Results

            **Status:** âœ… Passed

            **Dataset Info:**
            - Total rows: ${report.dataset_info.total_rows}
            - Total features: ${report.dataset_info.total_features}

            **Quality Checks:**
            - Missing values: ${report.quality_checks.missing_values ? 'âš ï¸ Found' : 'âœ… None'}
            - Duplicates: ${report.quality_checks.duplicate_rows ? 'âš ï¸ Found' : 'âœ… None'}
            - Outliers detected: ${report.quality_checks.outliers_detected ? 'âš ï¸ Yes' : 'âœ… No'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # JOB 2: Model Training & Evaluation
  # ============================================================================
  train-model:
    name: ğŸ¤– Train & Evaluate Model
    runs-on: ubuntu-latest
    needs: data-validation  # Only runs if data validation succeeds

    outputs:
      model-version: ${{ steps.train.outputs.version }}
      r2-score: ${{ steps.train.outputs.r2 }}
      rmse: ${{ steps.train.outputs.rmse }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”§ Feature Engineering
        run: |
          echo "Creating ML features..."
          python pipeline/stage_02_feature_engineering.py
          echo "âœ… Feature engineering complete!"

      - name: ğŸ¤– Train Model with MLflow
        id: train
        run: |
          echo "Training model with MLflow tracking..."
          python pipeline/stage_03_train_model_mlflow.py

          # Extract metrics from evaluation report
          R2=$(jq -r '.metrics.r2_score' logs/evaluation_report.json)
          RMSE=$(jq -r '.metrics.rmse' logs/evaluation_report.json)
          VERSION=$(jq -r '.model_metadata.version_id' logs/evaluation_report.json || echo "unknown")

          echo "Model trained!"
          echo "  RÂ² Score: $R2"
          echo "  RMSE: $RMSE"
          echo "  Version: $VERSION"

          # Set outputs for next jobs
          echo "r2=$R2" >> $GITHUB_OUTPUT
          echo "rmse=$RMSE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Check quality gates
          R2_THRESHOLD=0.75
          RMSE_THRESHOLD=50000

          if (( $(echo "$R2 < $R2_THRESHOLD" | bc -l) )); then
            echo "âŒ Model RÂ² ($R2) below threshold ($R2_THRESHOLD)"
            exit 1
          fi

          if (( $(echo "$RMSE > $RMSE_THRESHOLD" | bc -l) )); then
            echo "âŒ Model RMSE ($RMSE) above threshold ($RMSE_THRESHOLD)"
            exit 1
          fi

          echo "âœ… Model passed quality gates!"

      - name: ğŸ“Š Upload evaluation report
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-report
          path: logs/evaluation_report.json
          retention-days: 30

      - name: ğŸ“¦ Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            models/saved_models/*.joblib
            models/model_registry/registry.json
          retention-days: 90

      - name: ğŸ’¬ Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('logs/evaluation_report.json', 'utf8'));

            const r2 = report.metrics.r2_score.toFixed(4);
            const rmse = report.metrics.rmse.toFixed(0);
            const mae = report.metrics.mae.toFixed(0);
            const r2_pct = (r2 * 100).toFixed(2);

            const comment = `## ğŸ¤– Model Training Results

            **Status:** âœ… Passed Quality Gates

            **Performance Metrics:**
            - RÂ² Score: **${r2}** (${r2_pct}%)
            - RMSE: **$${rmse}**
            - MAE: **$${mae}**

            **Quality Gates:**
            - âœ… RÂ² â‰¥ 0.75
            - âœ… RMSE â‰¤ $50,000

            **Model Version:** ${report.model_metadata.version_id || 'N/A'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # JOB 3: Push Artifacts to Registry (Only on main branch)
  # ============================================================================
  push-to-registry:
    name: ğŸ“¤ Push to Model Registry
    runs-on: ubuntu-latest
    needs: train-model
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“¥ Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts
          path: models/

      - name: ğŸ“¤ Push to MLflow Model Registry
        run: |
          echo "Pushing model to registry..."
          python save_pipeline_to_mlflow.py

          echo "âœ… Model pushed to MLflow registry!"
          echo "  Model Name: housing_price_predictor_pipeline"
          echo "  RÂ² Score: ${{ needs.train-model.outputs.r2-score }}"
          echo "  RMSE: ${{ needs.train-model.outputs.rmse }}"

      # Optional: Push to external registry (AWS S3, GCS, Azure Blob)
      # - name: ğŸ“¤ Push to Cloud Storage
      #   run: |
      #     # Example: Push to S3
      #     aws s3 cp models/saved_models/ s3://your-bucket/models/ --recursive

      - name: ğŸ·ï¸ Create GitHub Release Tag
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.train-model.outputs.model-version }}';
            const r2 = '${{ needs.train-model.outputs.r2-score }}';
            const rmse = '${{ needs.train-model.outputs.rmse }}';

            const tagName = `model-${version}`;
            const releaseName = `Model ${version}`;

            const releaseBody = `## ğŸ¤– Model Release

            **Version:** ${version}
            **Date:** ${new Date().toISOString().split('T')[0]}

            **Performance:**
            - RÂ² Score: ${r2}
            - RMSE: $${rmse}

            **Artifacts:**
            - Model trained and validated
            - Pushed to MLflow registry
            - Available for deployment

            **Quality Gates:** âœ… All Passed
            `;

            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: releaseName,
                body: releaseBody,
                draft: false,
                prerelease: false
              });
              console.log(`âœ… Created release: ${tagName}`);
            } catch (error) {
              console.log(`Release already exists or error: ${error.message}`);
            }

      - name: ğŸ’¬ Notify Success
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## âœ… Model Deployed Successfully!

            **Model Version:** ${{ needs.train-model.outputs.model-version }}
            **RÂ² Score:** ${{ needs.train-model.outputs.r2-score }}
            **RMSE:** $${{ needs.train-model.outputs.rmse }}

            **Registry:** MLflow Model Registry
            **Status:** Available for deployment

            **Next Steps:**
            1. Review model in MLflow UI
            2. Test in staging environment
            3. Promote to production when ready
            `;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });

  # ============================================================================
  # JOB 4: Security & Code Quality Checks (Parallel)
  # ============================================================================
  code-quality:
    name: ğŸ”’ Code Quality & Security
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install linting tools
        run: |
          pip install flake8 black isort bandit

      - name: ğŸ¨ Check code formatting (Black)
        run: |
          black --check src/ pipeline/ || echo "âš ï¸ Code formatting issues found"

      - name: ğŸ” Lint code (Flake8)
        run: |
          flake8 src/ pipeline/ --max-line-length=120 || echo "âš ï¸ Linting issues found"

      - name: ğŸ”’ Security scan (Bandit)
        run: |
          bandit -r src/ pipeline/ || echo "âš ï¸ Security issues found"

      - name: ğŸ“‹ Check dependencies for vulnerabilities
        run: |
          pip install safety
          safety check --json || echo "âš ï¸ Vulnerable dependencies found"

# ============================================================================
# Workflow Summary
# ============================================================================
#
# This CI/CD pipeline automates your ML workflow:
#
# On Pull Request:
#   1. âœ… Validates data quality
#   2. âœ… Trains model
#   3. âœ… Checks quality gates
#   4. âœ… Comments results on PR
#   5. âŒ Does NOT push to registry
#
# On Push to Main:
#   1. âœ… Validates data quality
#   2. âœ… Trains model
#   3. âœ… Checks quality gates
#   4. âœ… Pushes to MLflow registry
#   5. âœ… Creates GitHub release
#   6. âœ… Notifies team
#
# Quality Gates:
#   - RÂ² Score must be â‰¥ 0.75
#   - RMSE must be â‰¤ $50,000
#   - Data validation must pass
#
# Artifacts Stored:
#   - Data quality reports (30 days)
#   - Evaluation reports (30 days)
#   - Model files (90 days)
#
# ============================================================================
